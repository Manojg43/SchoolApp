name: Backend CI/CD

on:
    push:
        branches: [main, master]
        paths:
            - "backend/**"
            - ".github/workflows/backend-ci.yml"
    pull_request:
        branches: [main, master]
        paths:
            - "backend/**"
            - ".github/workflows/backend-ci.yml"

jobs:
    lint-and-test:
        name: Lint & Test Backend
        runs-on: ubuntu-22.04
        defaults:
            run:
                working-directory: ./backend

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  # cache: "pip" - Disabled to ensure clean build
                  # cache-dependency-path: "backend/requirements.txt"

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libcairo2-dev libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf2.0-0 libffi-dev shared-mime-info libgirepository1.0-dev pkg-config python3-dev
                  # Verify cairo files
                  dpkg -L libcairo2-dev | grep pkgconfig
                  # Verify cairo installation via pkg-config
                  export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig
                  pkg-config --cflags --libs cairo

            - name: Install dependencies
              run: |
                  export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig
                  python -m pip install --upgrade pip setuptools wheel
                  # Force install binary wheel for pycairo to avoid source build
                  # If this fails, the source build should now succeed with PKG_CONFIG_PATH
                  pip install "pycairo>=1.20" --only-binary=:all: || pip install "pycairo>=1.20"
                  # Install rest of requirements
                  pip install --prefer-binary -r requirements.txt
                  pip install flake8

            - name: Lint with Flake8
              run: |
                  # Stop the build if there are Python syntax errors or undefined names
                  flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
                  # Exit-zero treats all errors as warnings
                  flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

            - name: Run Django Checks
              run: |
                  python manage.py check
              env:
                  DEBUG: "True"
                  SECRET_KEY: "test-secret-key-for-ci-only"
                  DATABASE_URL: "sqlite:///db.sqlite3"

            - name: Run Tests with Coverage
              run: |
                  pytest --cov=. --cov-report=xml --cov-fail-under=0
              env:
                  DEBUG: "True"
                  SECRET_KEY: "test-secret-key-for-ci-only"
                  DATABASE_URL: "sqlite:///db.sqlite3"
              continue-on-error: true

            - name: Upload Coverage Report
              uses: codecov/codecov-action@v4
              if: success()
              with:
                  files: coverage.xml
                  fail_ci_if_error: false
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    deploy:
        name: Deploy to Render
        needs: lint-and-test
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        runs-on: ubuntu-22.04

        steps:
            - name: Trigger Render Deploy
              run: |
                  curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
              # Note: You need to add RENDER_DEPLOY_HOOK_URL as a GitHub Secret
              # Get this from Render Dashboard > Your Web Service > Settings > Deploy Hooks
