name: Backend CI/CD

on:
    push:
        branches: [main, master]
        paths:
            - "backend/**"
    pull_request:
        branches: [main, master]
        paths:
            - "backend/**"

jobs:
    lint-and-test:
        name: Lint & Test Backend
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./backend

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"
                  cache-dependency-path: "backend/requirements.txt"

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf2.0-0 libffi-dev shared-mime-info

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install flake8

            - name: Lint with Flake8
              run: |
                  # Stop the build if there are Python syntax errors or undefined names
                  flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
                  # Exit-zero treats all errors as warnings
                  flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

            - name: Run Django Checks
              run: |
                  python manage.py check
              env:
                  DEBUG: "True"
                  SECRET_KEY: "test-secret-key-for-ci-only"
                  DATABASE_URL: "sqlite:///db.sqlite3"

            - name: Run Tests with Coverage
              run: |
                  pytest --cov=. --cov-report=xml --cov-fail-under=0
              env:
                  DEBUG: "True"
                  SECRET_KEY: "test-secret-key-for-ci-only"
                  DATABASE_URL: "sqlite:///db.sqlite3"
              continue-on-error: true

            - name: Upload Coverage Report
              uses: codecov/codecov-action@v4
              if: success()
              with:
                  files: coverage.xml
                  fail_ci_if_error: false
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    deploy:
        name: Deploy to Render
        needs: lint-and-test
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        runs-on: ubuntu-latest

        steps:
            - name: Trigger Render Deploy
              run: |
                  curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
              # Note: You need to add RENDER_DEPLOY_HOOK_URL as a GitHub Secret
              # Get this from Render Dashboard > Your Web Service > Settings > Deploy Hooks
